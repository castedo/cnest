#!/usr/bin/bash
set -o errexit

echo $'\u001b[1m'"THIS SCRIPT IS DEPRECATED."$'\u001b[0m'
echo "Use v2.x create-cnest."
echo "Replace your cnest v1.x ~/.config/cnest/profiles files,"
echo "with small personal shell scripts that call create-cnest."
echo

print_usage() {
    THIS_SCRIPT=$'\u001b[1m'"$(basename $0)"$'\u001b[0m'
    echo "Usage:"
    echo "  $THIS_SCRIPT"
    echo "    to print list of available permission profiles."
    echo "  $THIS_SCRIPT profile image_ref container_name"
    echo "    to build nest container."
}

PROFILE=$1
REPO_IMAGE=$2
CONTAINER_NAME=$3
PROFILE_DIR=$HOME/.config/cnest/profiles
if [[ -z $USER ]]; then
  USER=$(id -un)
fi

if [[ ! -d $PROFILE_DIR ]]; then
    echo "There are no cnest v1.x profile files."
    echo "Use v2.x create-cnest."
    exit 1
fi

if [[ -z $CONTAINER_NAME ]]; then
    print_usage
    if [[ -z $PROFILE ]]; then
        echo Permission profiles available from $PROFILE_DIR:
        ls --hide="_*" $PROFILE_DIR
    fi
    exit 1
fi

ERRMSG="Error reading permissions profile $PROFILE_DIR/$PROFILE"
trap "echo $ERRMSG" EXIT
ASSIGNMENT=$(
    set -o errexit
    cd "$PROFILE_DIR"
    source "$PROFILE"
    echo CREATE_OPTIONS=\"$CREATE_OPTIONS\"
)
trap - EXIT
eval $ASSIGNMENT

set -x

create-cnest \
    $REPO_IMAGE \
    --name "$CONTAINER_NAME" \
    $CREATE_OPTIONS \
    ;
