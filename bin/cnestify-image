#!/bin/bash
set -o errexit

BASE_IMAGE=$1
DEST_IMAGE=$2

if [[ ! $NESTSIGN ]]; then
    NESTSIGN=$'\xF0\x9F\x93\xA6'
fi
if [[ ! $NESTKIT_DIR ]]; then
  NESTKIT_DIR=$(python3 -m cnest.getpath nestkit)
fi
if [[ ! $CNEST_ENTRY ]]; then
  CNEST_ENTRY=$(python3 -m cnest.getpath cnest-entry)
fi
if [[ ! $PROFILE_DIR ]]; then
  PROFILE_DIR=$(python3 -m cnest.getpath profile-d)
fi

CONTAINER=$(buildah from "$BASE_IMAGE")

trap "buildah rm $CONTAINER" EXIT

set -x

buildah copy $CONTAINER "$NESTKIT_DIR" /opt/nestkit

buildah copy $CONTAINER "$CNEST_ENTRY" /usr/bin/

CONTAINER_SH_CMD="echo -n $NESTSIGN > /etc/nestsign"
buildah run $CONTAINER sh -c "$CONTAINER_SH_CMD"
buildah copy $CONTAINER "$PROFILE_DIR/." /etc/profile.d/

buildah commit $CONTAINER "$DEST_IMAGE"

