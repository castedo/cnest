#!/usr/bin/python3

import os, sys, pwd, subprocess, socket, yaml
from pathlib import Path

USER_SETUP_HOOK = '/usr/sbin/cnest-user-setup'
DEFAULT_PREF_PATH = Path.home() / ".config/cnest/homey-nest.yaml"

def parse_args():
    from argparse import ArgumentParser
    parser = ArgumentParser(description='Create user personalized container')
    parser.add_argument('image_tag', help="Image tag")
    parser.add_argument('-n', '--name',
                        help="Container name (default: image tag)")
    parser.add_argument('-u', '--user', help="User (default: current user)")
    parser.add_argument('-f', '--file', help="Preferences file")
    parser.add_argument('-b', '--base', help="Base repository")
    args = parser.parse_args()
    args.container_name = args.name or args.image_tag
    args.user = args.user or pwd.getpwuid(os.getuid()).pw_name
    if not args.file and os.path.exists(DEFAULT_PREF_PATH):
        args.file = DEFAULT_PREF_PATH
    prefs = dict()
    if args.file:
        with open(args.file) as f:
            prefs = yaml.load(f)
    args.home_mounts = prefs.get('home_mounts',[])
    args.base = args.base or prefs.get('base_repository')
    if not args.base:
        print("Base repository not specified", file=sys.stderr)
        parser.print_help()
        sys.exit(1)
    args.image = "localnests:" + args.image_tag
    return args

def run(args, **kwargs):
    print(" ".join(args))
    return subprocess.run(args, **kwargs)

def check_call(args):
    run(args, check=True)

def create_container(args):
    mounts = ['/tmp/.X11-unix']
    for hm in args.home_mounts:
        mounts.append(str(Path.home() / hm))
    volumes = ["--volume={0}:{0}".format(m) for m in mounts]
    check_call(['podman', 'create',
        '--userns=keep-id',
        '--pid=host',
        '--network=host',
        '--hostname', socket.gethostname(),
        '--privileged',
        '--cap-add=SYS_PTRACE',
        '--security-opt=seccomp=unconfined',
        '--user', args.user,
        '--name', args.container_name] +
        volumes +
        [args.image, 'sleep', '+Inf'])

if __name__ == "__main__":
    args = parse_args()
    try:
        base_image = args.base + ':' + args.image_tag
        check_call(['build-nest-image', base_image, args.image])
        create_container(args)
    except subprocess.CalledProcessError as ex:
        print("Error:", ex, file=sys.stderr)

